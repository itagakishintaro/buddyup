<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Firebase Chat</title>
        <link rel="icon" href="data:;base64,iVBORw0KGgo=">
        <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
        <style>
            body {
                font-family: 'HelveticaNeue-Light';
            }

            .msg {
                margin: 10px 0;
                padding: 10px;
                width: 400px;
                background-color: #efefef;
            }

            #username,
            #text {
                margin: 5px 0px;
            }

            #post {
                padding: 0.5em 1em;
                background-color: #50b1ff;
                border: none;
                color: #FFF;
            }

            #login {
                padding: 0.5em 1em;
                background-color: #DD4B39;
                border: none;
                color: #FFF;
                cursor: pointer;
            }
        </style>
    </head>

    <body>
        <button id="login">Login with Google</button><br/>
        <input id="text" type="text" placeholder="Message"><br/>
        <button id="post">Post</button><br/>
        <div id="results"></div>

        <script src="https://www.gstatic.com/firebasejs/5.0.2/firebase.js"></script>
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyAGW3s4tqAe8wAZY65hrM6YKpvKHj2dNjM",
                authDomain: "buddyup-204005.firebaseapp.com",
                databaseURL: "https://buddyup-204005.firebaseio.com",
                projectId: "buddyup-204005",
                storageBucket: "buddyup-204005.appspot.com",
                messagingSenderId: "541079223817"
            };
            firebase.initializeApp(config);
            var database = firebase.database();
        </script>

        <script>
            var textInput = document.querySelector('#text');
            var postButton = document.querySelector('#post');

            var username = null;
            var loginButton = document.querySelector('#login');
            postButton.style.display = "none";
            textInput.style.display = "none";

            postButton.addEventListener("click", function() {
                var msgText = textInput.value;
                database.ref('/').push({
                    username: username,
                    text: msgText
                });
                textInput.value = "";
            });

            /** Function to add a data listener **/
            var startListening = function() {
                database.ref('/').on('child_added', function(snapshot) {
                    var msg = snapshot.val();

                    var msgUsernameElement = document.createElement("b");
                    msgUsernameElement.textContent = msg.username;

                    var msgTextElement = document.createElement("p");
                    msgTextElement.textContent = msg.text;

                    var msgElement = document.createElement("div");
                    msgElement.appendChild(msgUsernameElement);
                    msgElement.appendChild(msgTextElement);

                    msgElement.className = "msg";
                    document.getElementById("results").appendChild(msgElement);
                });
            }

            loginButton.addEventListener("click", function() {
                var provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider).then(function(result) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    // The signed-in user info.
                    var user = result.user;
                    username = user.displayName;
                    loginButton.textContent = "Logged in as " + username;
                    loginButton.disabled = true;
                    postButton.style.display = "block";
                    textInput.style.display = "block";
                    // Start listening for data, remove previous calls to this method
                    startListening();
                }).catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                });
            });
        </script>

    </body>

</html>
